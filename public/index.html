<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GameWatch - Sports Stream Notifications</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#00d4ff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="GameWatch">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #fff;
      padding: 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(90deg, #00d4ff, #7b2cbf);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle {
      color: #888;
      font-size: 1.1rem;
    }
    
    .install-btn {
      margin-top: 15px;
      padding: 12px 24px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(90deg, #00d4ff, #7b2cbf);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .install-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
    }
    
    .install-hint {
      margin-top: 15px;
      padding: 10px 16px;
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 8px;
      font-size: 0.9rem;
      color: #aaa;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .card.live-card {
      background: rgba(255, 0, 0, 0.08);
      border: 1px solid rgba(255, 0, 0, 0.3);
    }
    
    .card.live-card h2 {
      color: #ff4444;
    }
    
    .card h2 {
      font-size: 1.3rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card h2 .icon {
      font-size: 1.5rem;
    }
    
    .ntfy-setup {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
    }
    
    .ntfy-topic {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }
    
    .ntfy-topic-row {
      display: flex;
      gap: 10px;
    }
    
    .ntfy-topic input {
      flex: 1;
      min-width: 0;
      padding: 12px 16px;
      border-radius: 8px;
      border: 2px solid rgba(0, 212, 255, 0.5);
      background: rgba(0, 0, 0, 0.5);
      color: #00d4ff;
      font-size: 1.1rem;
      font-family: monospace;
      font-weight: 600;
    }
    
    .ntfy-topic button {
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      background: #00d4ff;
      color: #000;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .ntfy-topic button:hover {
      background: #00b8e6;
      transform: translateY(-1px);
    }
    
    .ntfy-instructions {
      font-size: 0.9rem;
      color: #aaa;
      line-height: 1.6;
    }
    
    .ntfy-instructions ol {
      margin: 10px 0 10px 20px;
    }
    
    .ntfy-instructions a {
      color: #00d4ff;
    }
    
    .ntfy-note {
      font-size: 0.85rem;
      color: #ffb800;
      background: rgba(255, 184, 0, 0.1);
      border: 1px solid rgba(255, 184, 0, 0.3);
      border-radius: 8px;
      padding: 10px 12px;
      margin: 15px 0;
    }
    
    .league-section {
      margin-bottom: 20px;
    }
    
    .league-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    
    .league-header:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .league-header .collapse-icon {
      margin-left: auto;
      transition: transform 0.3s;
    }
    
    .league-header.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .league-logo {
      font-size: 1.5rem;
    }
    
    .league-name {
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .teams-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
      transition: max-height 0.3s ease, opacity 0.3s ease, margin 0.3s ease;
    }
    
    .teams-grid.collapsed {
      max-height: 0;
      opacity: 0;
      margin-top: 0;
      overflow: hidden;
    }
    
    .team-btn {
      padding: 10px 12px;
      border-radius: 8px;
      border: 2px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      position: relative;
    }
    
    .team-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .team-btn.selected {
      border-color: #fff;
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.3);
    }
    
    .team-btn .abbrev {
      font-weight: 700;
      display: block;
      font-size: 1.1rem;
    }
    
    .team-btn .city {
      font-size: 0.7rem;
      opacity: 0.9;
    }
    
    .team-btn .league-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 0.65rem;
    }
    
    .games-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .game-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .game-card.live {
      background: rgba(255, 0, 0, 0.05);
      border: 1px solid rgba(255, 0, 0, 0.2);
    }
    
    .game-info {
      flex: 1;
    }
    
    .game-teams {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .game-meta {
      font-size: 0.85rem;
      color: #888;
    }
    
    .game-league {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .game-league.nhl { background: rgba(0, 50, 160, 0.5); }
    .game-league.nba { background: rgba(200, 50, 50, 0.5); }
    .game-league.mlb { background: rgba(0, 80, 160, 0.5); }
    .game-league.nfl { background: rgba(1, 51, 105, 0.5); }
    
    .game-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .game-status.live {
      background: rgba(0, 200, 0, 0.3);
      color: #0f0;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .watch-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(90deg, #7b2cbf, #00d4ff);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .watch-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
    }
    
    .no-games {
      text-align: center;
      color: #666;
      padding: 40px;
    }
    
    .test-btn {
      margin-top: 10px;
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: transparent;
      color: #888;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .test-btn:hover {
      border-color: #00d4ff;
      color: #00d4ff;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .save-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 24px;
      background: rgba(0, 200, 0, 0.9);
      color: #fff;
      border-radius: 8px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
    }
    
    .save-indicator.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .setting-row {
      display: flex;
      align-items: center;
      gap: 15px;
      margin: 15px 0;
    }
    
    .setting-row label {
      font-size: 0.95rem;
    }
    
    .setting-row select {
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 0.95rem;
      cursor: pointer;
    }
    
    .setting-row select option {
      background: #1a1a2e;
      color: #fff;
    }
    
    .setting-note {
      font-size: 0.8rem;
      color: #666;
      margin-top: 10px;
    }
    
    .search-box {
      margin-bottom: 20px;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px 16px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 1rem;
    }
    
    .search-box input::placeholder {
      color: #666;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: #00d4ff;
    }
    
    .team-btn.hidden {
      display: none;
    }
    
    .my-teams-section {
      margin-bottom: 20px;
    }
    
    .my-teams-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px;
      border-radius: 8px;
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(123, 44, 191, 0.15));
      border: 1px solid rgba(0, 212, 255, 0.3);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
      margin-bottom: 12px;
    }
    
    .my-teams-header:hover {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.25), rgba(123, 44, 191, 0.25));
    }
    
    .my-teams-header .collapse-icon {
      margin-left: auto;
      transition: transform 0.3s;
    }
    
    .my-teams-header.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .my-teams-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 8px;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      margin-bottom: 15px;
    }
    
    .my-teams-grid.collapsed {
      max-height: 0;
      opacity: 0;
      margin-bottom: 0;
      overflow: hidden;
    }
    
    .no-teams-msg {
      grid-column: 1 / -1;
      color: #666;
      font-size: 0.9rem;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üèüÔ∏è GameWatch</h1>
      <p class="subtitle">Get notified when your teams play, with direct stream links</p>
      <button id="installBtn" class="install-btn" onclick="installApp()" style="display: none;">
        üì≤ Install App
      </button>
      <p id="installHint" class="install-hint" style="display: none;">
        üì≤ <strong>Install as app:</strong> Tap your browser menu (‚ãÆ) ‚Üí "Add to Home Screen" or "Install App"
      </p>
    </header>
    
    <div class="card live-card" id="liveGamesCard" style="display: none;">
      <h2><span class="icon">üî¥</span> Live Now</h2>
      <div id="liveGamesContainer">
      </div>
    </div>
    
    <div class="card">
      <h2><span class="icon">üìÖ</span> Upcoming Games</h2>
      <div id="upcomingGamesContainer">
        <div class="loading">Loading games...</div>
      </div>
    </div>
    
    <div class="card ntfy-setup">
      <h2><span class="icon">üîî</span> Notification Setup</h2>
      <p class="ntfy-instructions">
        Subscribe to your personal notification channel to get alerts when games start:
      </p>
      <div class="ntfy-topic">
        <label style="color: #888; font-size: 0.9rem;">Your topic:</label>
        <div class="ntfy-topic-row">
          <input type="text" id="ntfyUrl" readonly placeholder="Loading...">
          <button onclick="copyNtfyUrl()">Copy</button>
        </div>
      </div>
      <p class="ntfy-instructions">
        <ol>
          <li>Install the <a href="https://ntfy.sh" target="_blank">ntfy app</a> on your phone</li>
          <li>Tap "+" and enter the topic name above</li>
          <li>Tap the <strong>‚ö° lightning bolt</strong> icon to enable instant delivery</li>
          <li>You'll get notifications with stream links when your games start!</li>
        </ol>
      </p>
      <p class="ntfy-note">‚ö° <strong>Important:</strong> Without instant delivery enabled, notifications may be delayed or not appear on your lock screen.</p>
      <button class="test-btn" onclick="testNotification()">Send Test Notification</button>
    </div>
    
    <div class="card">
      <h2><span class="icon">‚öôÔ∏è</span> Settings</h2>
      <div class="setting-row">
        <label for="browserSelect">Open streams in:</label>
        <select id="browserSelect" onchange="saveBrowserPreference()">
          <option value="default">Default Browser</option>
          <option value="chrome">Chrome</option>
          <option value="firefox">Firefox</option>
          <option value="brave">Brave</option>
          <option value="edge">Edge</option>
          <option value="samsung">Samsung Internet</option>
          <option value="opera">Opera</option>
        </select>
      </div>
      <p class="setting-note">Android: Opens in selected browser. iOS/Desktop: Uses your default browser.</p>
    </div>
    
    <div class="card">
      <h2><span class="icon">‚≠ê</span> Your Teams</h2>
      <p style="color: #888; margin-bottom: 15px; font-size: 0.9rem;">
        Select the teams you want to follow. You'll be notified when they play.
      </p>
      
      <div class="my-teams-section">
        <div class="my-teams-header" onclick="toggleMyTeams()">
          <span class="icon">üí´</span>
          <span class="league-name">My Teams</span>
          <span id="myTeamsCount" style="color: #666; font-size: 0.85rem;">(0 selected)</span>
          <span class="collapse-icon" id="myTeamsCollapseIcon">‚ñº</span>
        </div>
        <div class="my-teams-grid" id="myTeamsGrid">
          <p class="no-teams-msg" id="noTeamsMsg">No teams selected yet. Choose from the leagues below!</p>
        </div>
      </div>
      
      <div class="search-box">
        <input type="text" id="teamSearch" placeholder="Search teams..." oninput="filterTeams()">
      </div>
      <div id="teamsContainer">
        <div class="loading">Loading teams...</div>
      </div>
    </div>
  
  <div class="save-indicator" id="saveIndicator">‚úì Saved</div>
  
  <script>
    let userId = localStorage.getItem('gamewatch_userId');
    let userData = null;
    let allTeams = {};
    
    // League display info
    const leagueInfo = {
      nhl: { name: 'NHL', icon: 'üèí' },
      nba: { name: 'NBA', icon: 'üèÄ' },
      mlb: { name: 'MLB', icon: '‚öæ' },
      nfl: { name: 'NFL', icon: 'üèà' }
    };
    
    async function init() {
      // Get or create user
      const response = await fetch('/api/user', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId })
      });
      userData = await response.json();
      userId = userData.userId;
      localStorage.setItem('gamewatch_userId', userId);
      
      // Update ntfy topic (just the topic name, not the full URL)
      document.getElementById('ntfyUrl').value = userData.ntfyTopic;
      
      // Load teams
      const teamsResponse = await fetch('/api/teams');
      allTeams = await teamsResponse.json();
      
      renderTeams();
      renderMyTeams();
      loadGames();
    }
    
    // Track collapsed state
    const collapsedLeagues = JSON.parse(localStorage.getItem('gamewatch_collapsed') || '{}');
    let myTeamsCollapsed = localStorage.getItem('gamewatch_myteams_collapsed') === 'true';
    
    function toggleMyTeams() {
      myTeamsCollapsed = !myTeamsCollapsed;
      localStorage.setItem('gamewatch_myteams_collapsed', myTeamsCollapsed);
      
      const header = document.querySelector('.my-teams-header');
      const grid = document.getElementById('myTeamsGrid');
      
      header.classList.toggle('collapsed', myTeamsCollapsed);
      grid.classList.toggle('collapsed', myTeamsCollapsed);
    }
    
    function renderMyTeams() {
      const grid = document.getElementById('myTeamsGrid');
      const countSpan = document.getElementById('myTeamsCount');
      const noTeamsMsg = document.getElementById('noTeamsMsg');
      const header = document.querySelector('.my-teams-header');
      
      // Gather all selected teams
      const selectedTeams = [];
      for (const [league, teams] of Object.entries(userData.teams || {})) {
        for (const abbrev of teams) {
          const team = allTeams[league]?.find(t => t.abbrev === abbrev);
          if (team) {
            selectedTeams.push({ ...team, league });
          }
        }
      }
      
      countSpan.textContent = `(${selectedTeams.length} selected)`;
      
      // Apply collapsed state
      header.classList.toggle('collapsed', myTeamsCollapsed);
      grid.classList.toggle('collapsed', myTeamsCollapsed);
      
      if (selectedTeams.length === 0) {
        grid.innerHTML = `<p class="no-teams-msg">No teams selected yet. Choose from the leagues below!</p>`;
        return;
      }
      
      grid.innerHTML = selectedTeams.map(team => `
        <button 
          class="team-btn selected"
          data-league="${team.league}"
          data-abbrev="${team.abbrev}"
          onclick="event.stopPropagation(); toggleTeam('${team.league}', '${team.abbrev}')"
          style="background: ${team.color || '#333'};"
        >
          <span class="abbrev">${team.abbrev}</span>
          <span class="city">${team.city}</span>
          <span class="league-badge">${leagueInfo[team.league]?.icon || ''}</span>
        </button>
      `).join('');
    }
    
    function toggleLeague(league) {
      collapsedLeagues[league] = !collapsedLeagues[league];
      localStorage.setItem('gamewatch_collapsed', JSON.stringify(collapsedLeagues));
      
      const header = document.querySelector(`[data-league-header="${league}"]`);
      const grid = document.querySelector(`[data-league-grid="${league}"]`);
      
      header.classList.toggle('collapsed', collapsedLeagues[league]);
      grid.classList.toggle('collapsed', collapsedLeagues[league]);
    }
    
    function renderTeams() {
      const container = document.getElementById('teamsContainer');
      container.innerHTML = '';
      
      for (const [league, teams] of Object.entries(allTeams)) {
        const section = document.createElement('div');
        section.className = 'league-section';
        
        const info = leagueInfo[league];
        const selectedTeams = userData.teams?.[league] || [];
        const isCollapsed = collapsedLeagues[league];
        
        section.innerHTML = `
          <div class="league-header ${isCollapsed ? 'collapsed' : ''}" data-league-header="${league}" onclick="toggleLeague('${league}')">
            <span class="league-logo">${info.icon}</span>
            <span class="league-name">${info.name}</span>
            <span style="color: #666; font-size: 0.85rem;">(${selectedTeams.length} selected)</span>
            <span class="collapse-icon">‚ñº</span>
          </div>
          <div class="teams-grid ${isCollapsed ? 'collapsed' : ''}" data-league-grid="${league}">
            ${teams.map(team => `
              <button 
                class="team-btn ${selectedTeams.includes(team.abbrev) ? 'selected' : ''}"
                data-league="${league}"
                data-abbrev="${team.abbrev}"
                onclick="event.stopPropagation(); toggleTeam('${league}', '${team.abbrev}')"
                style="background: ${team.color || '#333'};"
              >
                <span class="abbrev">${team.abbrev}</span>
                <span class="city">${team.city}</span>
              </button>
            `).join('')}
          </div>
        `;
        
        container.appendChild(section);
      }
    }
    
    async function toggleTeam(league, abbrev) {
      if (!userData.teams[league]) {
        userData.teams[league] = [];
      }
      
      const idx = userData.teams[league].indexOf(abbrev);
      if (idx === -1) {
        userData.teams[league].push(abbrev);
      } else {
        userData.teams[league].splice(idx, 1);
      }
      
      // Update UI immediately
      renderTeams();
      renderMyTeams();
      
      // Save to server
      await fetch(`/api/user/${userId}/teams`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ teams: userData.teams })
      });
      
      showSaveIndicator();
      loadGames();
    }
    
    async function loadGames() {
      const liveContainer = document.getElementById('liveGamesContainer');
      const upcomingContainer = document.getElementById('upcomingGamesContainer');
      const liveCard = document.getElementById('liveGamesCard');
      
      try {
        const response = await fetch(`/api/games/${userId}`);
        const games = await response.json();
        
        // Split into live and upcoming
        const liveGames = games.filter(g => 
          g.state === 'LIVE' || g.state === 'STATUS_IN_PROGRESS'
        );
        const upcomingGames = games.filter(g => 
          g.state !== 'LIVE' && g.state !== 'STATUS_IN_PROGRESS' && 
          g.state !== 'FINAL' && g.state !== 'STATUS_FINAL'
        );
        
        // Sort by start time
        liveGames.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
        upcomingGames.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
        
        // Show/hide live card
        if (liveGames.length > 0) {
          liveCard.style.display = 'block';
          liveContainer.innerHTML = `
            <div class="games-list">
              ${liveGames.map(game => renderGameCard(game, true)).join('')}
            </div>
          `;
        } else {
          liveCard.style.display = 'none';
        }
        
        // Render upcoming
        if (upcomingGames.length === 0) {
          upcomingContainer.innerHTML = `
            <div class="no-games">
              <p>No upcoming games for your teams in the next 24 hours.</p>
              <p style="margin-top: 10px; font-size: 0.85rem;">Select some teams below to get started!</p>
            </div>
          `;
        } else {
          upcomingContainer.innerHTML = `
            <div class="games-list">
              ${upcomingGames.map(game => renderGameCard(game, false)).join('')}
            </div>
          `;
        }
      } catch (err) {
        upcomingContainer.innerHTML = `<div class="no-games">Error loading games</div>`;
      }
    }
    
    function renderGameCard(game, isLive) {
      const startTime = new Date(game.startTime);
      const timeStr = startTime.toLocaleString([], { 
        weekday: 'short',
        hour: 'numeric', 
        minute: '2-digit'
      });
      
      return `
        <div class="game-card ${isLive ? 'live' : ''}">
          <div class="game-info">
            <div class="game-teams">${game.awayTeamName} @ ${game.homeTeamName}</div>
            <div class="game-meta">
              <span class="game-league ${game.league}">${game.league.toUpperCase()}</span>
              ${isLive ? '<span class="game-status live">‚óè LIVE</span>' : timeStr}
            </div>
          </div>
          ${game.streamUrl ? `
            <a href="${game.streamUrl}" onclick="event.preventDefault(); openStream('${game.streamUrl}');" class="watch-btn">
              Watch
            </a>
          ` : ''}
        </div>
      `;
    }
    
    function copyNtfyUrl() {
      const input = document.getElementById('ntfyUrl');
      navigator.clipboard.writeText(input.value);
      
      const btn = input.nextElementSibling;
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 2000);
    }
    
    async function testNotification() {
      const btn = event.target;
      btn.textContent = 'Sending...';
      btn.disabled = true;
      
      try {
        await fetch(`/api/test-notification/${userId}`, { method: 'POST' });
        btn.textContent = 'Sent!';
      } catch (err) {
        btn.textContent = 'Failed';
      }
      
      setTimeout(() => {
        btn.textContent = 'Send Test Notification';
        btn.disabled = false;
      }, 2000);
    }
    
    function showSaveIndicator() {
      const indicator = document.getElementById('saveIndicator');
      indicator.classList.add('show');
      setTimeout(() => indicator.classList.remove('show'), 1500);
    }
    
    async function saveBrowserPreference() {
      const browser = document.getElementById('browserSelect').value;
      localStorage.setItem('gamewatch_browser', browser);
      
      // Also save to server for notifications
      await fetch(`/api/user/${userId}/browser`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ browser })
      });
      
      showSaveIndicator();
    }
    
    function loadBrowserPreference() {
      const browser = localStorage.getItem('gamewatch_browser') || userData?.browser || 'default';
      document.getElementById('browserSelect').value = browser;
    }
    
    function filterTeams() {
      const search = document.getElementById('teamSearch').value.toLowerCase().trim();
      const buttons = document.querySelectorAll('.team-btn');
      
      buttons.forEach(btn => {
        const abbrev = btn.dataset.abbrev.toLowerCase();
        const league = btn.dataset.league.toLowerCase();
        const city = btn.querySelector('.city')?.textContent.toLowerCase() || '';
        
        // Get full team name from allTeams
        const team = allTeams[btn.dataset.league]?.find(t => t.abbrev === btn.dataset.abbrev);
        const fullName = team?.name.toLowerCase() || '';
        
        const matches = abbrev.includes(search) || 
                       city.includes(search) || 
                       fullName.includes(search) ||
                       league.includes(search);
        
        btn.classList.toggle('hidden', !matches);
      });
      
      // Hide empty league sections
      document.querySelectorAll('.league-section').forEach(section => {
        const visibleTeams = section.querySelectorAll('.team-btn:not(.hidden)').length;
        section.style.display = visibleTeams === 0 ? 'none' : 'block';
      });
    }
    
    function openStream(url) {
      const browser = localStorage.getItem('gamewatch_browser') || 'default';
      const isAndroid = /Android/i.test(navigator.userAgent);
      
      if (!isAndroid || browser === 'default') {
        window.open(url, '_blank');
        return;
      }
      
      // Android intent URLs - must use location.href, not window.open
      const androidIntents = {
        'chrome': `intent://${url.replace(/^https?:\/\//, '')}#Intent;scheme=https;package=com.android.chrome;end`,
        'firefox': `intent://${url.replace(/^https?:\/\//, '')}#Intent;scheme=https;package=org.mozilla.firefox;end`,
        'brave': `intent://${url.replace(/^https?:\/\//, '')}#Intent;scheme=https;package=com.brave.browser;end`,
        'edge': `intent://${url.replace(/^https?:\/\//, '')}#Intent;scheme=https;package=com.microsoft.emmx;end`,
        'samsung': `intent://${url.replace(/^https?:\/\//, '')}#Intent;scheme=https;package=com.sec.android.app.sbrowser;end`,
        'opera': `intent://${url.replace(/^https?:\/\//, '')}#Intent;scheme=https;package=com.opera.browser;end`
      };
      
      const intentUrl = androidIntents[browser];
      if (intentUrl) {
        window.location.href = intentUrl;
      } else {
        window.open(url, '_blank');
      }
    }
    
    // Refresh games every minute
    setInterval(loadGames, 60000);
    
    // Initialize
    init();
    loadBrowserPreference();
    
    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then((reg) => console.log('Service worker registered'))
        .catch((err) => console.log('Service worker registration failed:', err));
    }
    
    // Handle PWA install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      // Show install button
      document.getElementById('installBtn').style.display = 'block';
      document.getElementById('installHint').style.display = 'none';
    });
    
    // Show manual install hint if no prompt after 2 seconds
    setTimeout(() => {
      if (!deferredPrompt && !window.matchMedia('(display-mode: standalone)').matches) {
        document.getElementById('installHint').style.display = 'block';
      }
    }, 2000);
    
    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('User accepted install');
          }
          deferredPrompt = null;
          document.getElementById('installBtn').style.display = 'none';
        });
      }
    }
  </script>
</body>
</html>
